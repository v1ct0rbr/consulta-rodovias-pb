<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>CRUD Rodovias PB</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f8fb; }
    h1 { color: #004080; }
    input, select { padding: 6px; margin: 5px; }
    button { padding: 6px 12px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
    .add { background: #28a745; color: white; }
    .edit { background: #ffc107; }
    .delete { background: #dc3545; color: white; }
    .save { background: #007bff; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #004080; color: white; }
  </style>
</head>
<body>
  <h1>üìã CRUD - Rodovias do DER-PB</h1>

  <h3>Adicionar / Editar Trecho</h3>
  <label>Resid√™ncia:</label>
  <input type="text" id="residencia"><br>
  <label>Rodovia:</label>
  <input type="text" id="rodovia"><br>
  <label>Trecho:</label>
  <input type="text" id="trecho"><br>
  <label>In√≠cio (Km):</label>
  <input type="number" id="inicio"><br>
  <label>Fim (Km):</label>
  <input type="number" id="fim"><br>
  <label>Extens√£o (Km):</label>
  <input type="number" id="extensao"><br>
  <label>Situa√ß√£o F√≠sica:</label>
  <input type="text" id="sitFis"><br>
  <button class="add" onclick="adicionarTrecho()">Adicionar</button>
  <button class="save" onclick="salvarJSON()">Exportar JSON</button>

  <h3>Lista de Trechos</h3>
  <table id="tabela">
    <thead>
      <tr>
        <th>Resid√™ncia</th>
        <th>Rodovia</th>
        <th>Trecho</th>
        <th>In√≠cio</th>
        <th>Fim</th>
        <th>Extens√£o</th>
        <th>Situa√ß√£o</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let dados = {};

    // Carregar o banco inicial do JSON
    fetch("trechos_residencias.json")
      .then(r => r.json())
      .then(json => {
        dados = json;
        renderTabela();
      });

    function renderTabela() {
      const tbody = document.querySelector("#tabela tbody");
      tbody.innerHTML = "";

      for (const residencia in dados) {
        dados[residencia].forEach((trecho, idx) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${residencia}</td>
            <td>${trecho.Rodovia}</td>
            <td>${trecho.Trecho}</td>
            <td>${trecho["In√≠cio (Km)"] || ""}</td>
            <td>${trecho["Fim (Km)"] || ""}</td>
            <td>${trecho["Extens√£o (Km)"] || ""}</td>
            <td>${trecho["Situa√ß√£o F√≠sica"] || ""}</td>
            <td>
              <button class="edit" onclick="editarTrecho('${residencia}', ${idx})">Editar</button>
              <button class="delete" onclick="excluirTrecho('${residencia}', ${idx})">Excluir</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }
    }

    function adicionarTrecho() {
      const residencia = document.getElementById("residencia").value;
      const rodovia = document.getElementById("rodovia").value;
      const trecho = document.getElementById("trecho").value;
      const inicio = parseFloat(document.getElementById("inicio").value) || null;
      const fim = parseFloat(document.getElementById("fim").value) || null;
      const extensao = parseFloat(document.getElementById("extensao").value) || null;
      const sitFis = document.getElementById("sitFis").value;

      if (!residencia || !rodovia) {
        alert("Preencha pelo menos Resid√™ncia e Rodovia!");
        return;
      }

      if (!dados[residencia]) dados[residencia] = [];

      dados[residencia].push({
        "Rodovia": rodovia,
        "Trecho": trecho,
        "In√≠cio (Km)": inicio,
        "Fim (Km)": fim,
        "Extens√£o (Km)": extensao,
        "Situa√ß√£o F√≠sica": sitFis
      });

      renderTabela();
    }

    function editarTrecho(residencia, idx) {
      const trecho = dados[residencia][idx];
      document.getElementById("residencia").value = residencia;
      document.getElementById("rodovia").value = trecho.Rodovia;
      document.getElementById("trecho").value = trecho.Trecho;
      document.getElementById("inicio").value = trecho["In√≠cio (Km)"] || "";
      document.getElementById("fim").value = trecho["Fim (Km)"] || "";
      document.getElementById("extensao").value = trecho["Extens√£o (Km)"] || "";
      document.getElementById("sitFis").value = trecho["Situa√ß√£o F√≠sica"] || "";

      excluirTrecho(residencia, idx); // Remove e espera salvar de novo
    }

    function excluirTrecho(residencia, idx) {
      dados[residencia].splice(idx, 1);
      if (dados[residencia].length === 0) delete dados[residencia];
      renderTabela();
    }

    function salvarJSON() {
      const blob = new Blob([JSON.stringify(dados, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "trechos_residencias_atualizado.json";
      a.click();
    }
  </script>
</body>
</html>
